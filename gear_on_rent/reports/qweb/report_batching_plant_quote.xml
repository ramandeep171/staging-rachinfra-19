<odoo>
    <record id="action_report_batching_plant_quote" model="ir.actions.report">
        <field name="name">Batching Plant Quotation</field>
        <field name="model">sale.order</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">gear_on_rent.report_batching_plant_quote</field>
        <field name="report_file">gear_on_rent.report_batching_plant_quote</field>
        <field name="print_report_name">(object.name or 'Batching Plant Quote')</field>
        <field name="binding_model_id" ref="sale.model_sale_order"/>
        <field name="binding_type">report</field>
    </record>

    <template id="report_batching_plant_quote">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-set="pdf_data" t-value="pdf_data"/>
                <t t-set="chart_urls" t-value="chart_urls"/>
                <t t-set="order" t-value="doc"/>
                <t t-set="plant_slabs" t-value="pdf_data.get('plant_slabs') or {}"/>
                <t t-set="slab_rates" t-value="pdf_data.get('plant_slabs') or pdf_data.get('slab_rates') or {}"/>
                <t t-set="material_breakdown" t-value="pdf_data.get('material_breakdown') or {}"/>
                <t t-set="optional_services" t-value="pdf_data.get('optional_services') or []"/>
                <t t-set="capex_breakdown" t-value="pdf_data.get('capex_breakdown') or {}"/>
                <t t-set="capex_items" t-value="pdf_data.get('capex_items') or capex_breakdown.get('items') or []"/>
                <t t-set="project_duration" t-value="pdf_data.get('project_duration')"/>
                <t t-set="final_rate" t-value="pdf_data.get('final_rates') or {'total_rate_per_cum': pdf_data.get('final_rate')}"/>
                <t t-set="final_rates" t-value="pdf_data.get('final_rates') or final_rate"/>
                <t t-set="source_map" t-value="pdf_data.get('source_map') or final_rates.get('source_map') or {}"/>
                <t t-set="running_map" t-value="source_map.get('running', {})"/>
                <t t-set="dead_cost_per_cum" t-value="pdf_data.get('dead_cost') or final_rate.get('dead_cost') or order.gear_dead_cost_per_cum or 0.0"/>
                <t t-set="dead_cost_context" t-value="pdf_data.get('dead_cost_context') or {
                    'per_cum': dead_cost_per_cum,
                    'total': capex_breakdown.get('total_amount') or order.gear_dead_cost_amount or 0.0,
                }"/>
                <t t-set="quotation_context" t-value="pdf_data.get('quotation_context') or {
                    'inventory_mode': order.x_inventory_mode,
                    'civil_scope': order.gear_civil_scope,
                    'area_name': order.gear_material_area_id.name if order.gear_material_area_id else False,
                    'service_type': order.gear_service_type,
                    'capacity': order.gear_capacity_id.name if order.gear_capacity_id else False,
                    'grade': order.gear_design_mix_id.grade if order.gear_design_mix_id else False,
                    'project_duration_months': order.gear_project_duration_months or (order.gear_project_duration_years and order.gear_project_duration_years * 12) or False,
                    'show_cost_breakdown': order.gear_show_cost_breakdown,
                }"/>
                <t t-set="currency" t-value="order.currency_id if order else False"/>
                <t t-set="company" t-value="order.company_id if order else False"/>
                <t t-set="partner" t-value="order.partner_id if order else False"/>

                <t t-if="order">
                    <t t-call="web.external_layout">
                        <div class="page">
                            

                            <t t-set="address">
                                <div t-field="doc.partner_id" class="mb-0" t-options="{'widget': 'contact', 'fields': ['address', 'name'], 'no_marker': True}"/>
                                <p t-if="doc.partner_id.vat" class="mb-0">
                                    <t t-if="doc.company_id.account_fiscal_country_id.vat_label" t-out="doc.company_id.account_fiscal_country_id.vat_label"/>
                                    <t t-else="">Tax ID</t>: <span t-field="doc.partner_id.vat"/>
                                </p>
                            </t>

                            <t t-if="doc.partner_shipping_id == doc.partner_invoice_id and doc.partner_invoice_id != doc.partner_id or doc.partner_shipping_id != doc.partner_invoice_id">
                                <t t-set="information_block">
                                    <strong>
                                        <t t-if="doc.partner_shipping_id == doc.partner_invoice_id">
                                            Invoicing and Shipping Address
                                        </t>
                                        <t t-else="">
                                            Invoicing Address
                                        </t>
                                    </strong>
                                    <div t-field="doc.partner_invoice_id" t-options="{'widget': 'contact', 'fields': ['address', 'name', 'phone'], 'no_marker': True, 'phone_icons': True}"/>
                                    <t t-if="doc.partner_shipping_id != doc.partner_invoice_id">
                                        <strong class="d-block mt-3">Shipping Address</strong>
                                        <div t-field="doc.partner_shipping_id" t-options="{'widget': 'contact', 'fields': ['address', 'name', 'phone'], 'no_marker': True, 'phone_icons': True}"/>
                                    </t>
                                </t>
                            </t>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <span t-if="information_block" t-field="doc.partner_shipping_id" t-options="{'widget': 'contact', 'fields': ['address', 'name'], 'no_marker': True}"/>
                                    <span t-if="not information_block" t-raw="address"/>
                                </div>
                                <div class="col-6 text-end">
                                    <div t-if="information_block" t-raw="information_block"/>
                                </div>
                            </div>
                            <t t-set="doc" t-value="order.with_context(lang=order.partner_id.lang)"/>
                            <h2 class="text-center mb-3">Batching Plant Quotation</h2>

                           
                            <h4 class="mb-2">Service Summary</h4>
                            <t t-set="grade_raw" t-value="quotation_context.get('grade') or (order.gear_design_mix_id.grade if order.gear_design_mix_id else False)"/>
                            <t t-set="grade_value" t-value="grade_raw if grade_raw not in ('', '-', None, False) else False"/>
                            <t t-set="area_raw" t-value="quotation_context.get('area_name') or (order.gear_material_area_id.name if order.gear_material_area_id else False)"/>
                            <t t-set="area_value" t-value="area_raw if area_raw not in ('', '-', None, False) else False"/>
                            <t t-set="plant_running_value" t-value="quotation_context.get('plant_running') or order.gear_plant_running or False"/>
                            <t t-set="plant_running_label" t-value="{'power': 'On Power', 'diesel': 'On Diesel'}.get(plant_running_value) or plant_running_value"/>
                            <ul class="list-unstyled">
                                <li><strong>Service Type:</strong> <t t-esc="quotation_context.get('service_type') or order.gear_service_type or '-'"/></li>
                                <li><strong>Plant Capacity:</strong> <t t-esc="quotation_context.get('capacity') or (order.gear_capacity_id.name if order.gear_capacity_id else '-')"/></li>
                                <li><strong>Inventory Mode:</strong> <t t-esc="quotation_context.get('inventory_mode') or order.x_inventory_mode or '-'"/></li>
                                <li t-if="plant_running_label"><strong>Plant Running:</strong> <t t-esc="plant_running_label"/></li>
                                <li t-if="grade_value"><strong>Grade:</strong> <t t-esc="grade_value"/></li>
                                <li><strong>Project Duration:</strong> <t t-esc="quotation_context.get('project_duration_months') or order.gear_project_duration_months or 0"/> months</li>
                                <li><strong>Civil Scope:</strong> <t t-esc="quotation_context.get('civil_scope') or order.gear_civil_scope or '-'"/></li>
                                <li t-if="area_value"><strong>Area:</strong> <t t-esc="area_value"/></li>
                            </ul>

                            <h4 class="mt-3 mb-2">MGQ Summary</h4>
                            <table class="table table-sm o_main_table">
                                <thead>
                                    <tr>
                                        <th>Label</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Monthly Guaranteed Quantity (MGQ)</td>
                                        <td t-esc="formatLang(pdf_data.get('mgq') or plant_slabs.get('mgq') or order.mgq_monthly or order.x_monthly_mgq or 0, digits=2)"/>
                                    </tr>
                                    <tr>
                                        <td>Production Expectation</td>
                                        <td t-esc="formatLang(pdf_data.get('production_expectation') or order.gear_expected_production_qty or 0, digits=2)"/>
                                    </tr>
                                    <tr>
                                        <td>Project Duration</td>
                                        <td>
                                            <t t-if="order.gear_project_duration_months"><t t-esc="order.gear_project_duration_months"/> months</t>
                                            <t t-elif="project_duration"><t t-esc="project_duration"/> years</t>
                                            <t t-elif="order.gear_project_duration_years"><t t-esc="order.gear_project_duration_years"/> years</t>
                                            <t t-else="">-</t>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4 mb-2">Plant Cost (MGQ Slabs)</h4>
                            <table class="table table-sm o_main_table">
                                <thead>
                                    <tr>
                                        <th>Slab</th>
                                        <th>Rate / CUM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            Prime
                                            <div class="text-muted">Actual RMC quantity produced and billed.</div>
                                            <div class="text-muted">वास्तविक रूप से उत्पादित और बिल की गई RMC मात्रा।</div>
                                        </td>
                                        <td t-esc="formatLang(plant_slabs.get('prime_rate') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>
                                            Optimize
                                            <div class="text-muted">Balance MGQ quantity after adjusting prime production.</div>
                                            <div class="text-muted">प्राइम प्रोडक्शन घटाने के बाद शेष MGQ मात्रा।</div>
                                        </td>
                                        <td t-esc="formatLang(plant_slabs.get('optimize_rate') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>
                                            After MGQ
                                            <div class="text-muted">Quantity beyond MGQ charged at variable cost only.</div>
                                            <div class="text-muted">MGQ से अधिक मात्रा पर केवल वैरिएबल लागत लागू।</div>
                                        </td>
                                        <td t-esc="formatLang(plant_slabs.get('after_mgq_rate') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>

                        <section class="mt-4" t-if="(quotation_context.get('inventory_mode') or order.x_inventory_mode) == 'with_inventory'">
                            <h3>Material Cost</h3>
                            <t t-set="material_lines" t-value="material_breakdown.get('lines') or []"/>
                            <table class="table table-sm o_main_table" t-if="material_lines">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Qty</th>
                                        <th>Rate</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="material_lines" t-as="line">
                                        <td t-esc="line.get('label') or line.get('component')"/>
                                        <td t-esc="formatLang(line.get('qty') or 0.0, digits=2)"/>
                                        <td t-esc="formatLang(line.get('rate') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(line.get('total') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>
                            <table class="table table-sm o_main_table" t-if="not material_lines">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Qty</th>
                                        <th>Rate</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Cement</td>
                                        <td t-esc="formatLang(material_breakdown.get('cement_qty') or 0.0, digits=2)"/>
                                        <td t-esc="formatLang(material_breakdown.get('cement_rate') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(material_breakdown.get('cement_total') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>10mm Aggregate</td>
                                        <td t-esc="formatLang(material_breakdown.get('agg_10mm_qty') or 0.0, digits=2)"/>
                                        <td t-esc="formatLang(material_breakdown.get('agg_10mm_rate') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(material_breakdown.get('agg_10mm_total') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>20mm Aggregate</td>
                                        <td t-esc="formatLang(material_breakdown.get('agg_20mm_qty') or 0.0, digits=2)"/>
                                        <td t-esc="formatLang(material_breakdown.get('agg_20mm_rate') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(material_breakdown.get('agg_20mm_total') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>Admixture</td>
                                        <td t-esc="formatLang(material_breakdown.get('admixture_qty') or 0.0, digits=2)"/>
                                        <td t-esc="formatLang(material_breakdown.get('admixture_rate') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(material_breakdown.get('admixture_total') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </section>

                        <t t-set="prime_log" t-value="final_rates.get('prime_rate_log') or {}"/>
                        <t t-set="components" t-value="prime_log.get('components') or {}"/>
                        <t t-set="running_comp" t-value="components.get('running', {})"/>
                        <t t-set="depr_comp" t-value="components.get('depreciation', {})"/>
                        <t t-set="interest_comp" t-value="components.get('interest', {})"/>
                        <t t-set="dead_comp" t-value="components.get('dead_cost', {})"/>
                        <t t-set="depr_component_total" t-value="capex_breakdown.get('total_amount') or ((depr_comp.get('monthly_total') or 0.0) * (depr_comp.get('project_months') or 0.0))"/>
                        <t t-set="running_per_cum" t-value="running_comp.get('per_cum') or 0.0"/>
                        <t t-set="depr_per_cum" t-value="depr_comp.get('per_cum') or 0.0"/>
                        <t t-set="dead_per_cum" t-value="dead_comp.get('per_cum') or dead_cost_context.get('per_cum') or 0.0"/>
                        <t t-set="interest_per_cum" t-value="interest_comp.get('per_cum') or 0.0"/>
                        <t t-set="running_monthly" t-value="running_comp.get('monthly_total') or 0.0"/>
                        <t t-set="depr_monthly" t-value="depr_comp.get('monthly_total') or 0.0"/>
                        <t t-set="dead_total" t-value="dead_comp.get('total') or dead_cost_context.get('total') or 0.0"/>
                        <t t-set="interest_monthly" t-value="interest_comp.get('monthly_total') or 0.0"/>
                        <t t-set="mgq_value" t-value="plant_slabs.get('mgq') or final_rates.get('mgq') or order.mgq_monthly or order.x_monthly_mgq or 0.0"/>
                        <t t-set="margin_per_cum" t-value="components.get('margin', {}).get('per_cum') or 0.0"/>
                        <t t-set="margin_monthly" t-value="margin_per_cum * (mgq_value or 0.0)"/>
                        <t t-set="prime_base_monthly" t-value="running_monthly + depr_monthly + dead_total"/>
                        <t t-set="prime_base_per_cum" t-value="(running_per_cum or 0.0) + (depr_per_cum or 0.0) + (dead_per_cum or 0.0)"/>
                        <t t-set="prime_output_monthly" t-value="prime_base_monthly + margin_monthly"/>
                        <t t-set="prime_output_per_cum" t-value="prime_base_per_cum + margin_per_cum"/>
                        <t t-set="optional_cost_per_cum" t-value="final_rate.get('optional_cost') or pdf_data.get('optional_cost') or 0.0"/>
                        <t t-set="running_divisor" t-value="mgq_value or 1.0"/>
                        <t t-set="show_cost_breakdown" t-value="quotation_context.get('show_cost_breakdown') if 'show_cost_breakdown' in quotation_context else order.gear_show_cost_breakdown"/>
                        <t t-set="running_power_monthly" t-value="running_map.get('power') or 0.0"/>
                        <t t-set="running_power_per_cum" t-value="running_power_monthly / running_divisor if running_power_monthly else 0.0"/>
                        <t t-set="running_dg_monthly" t-value="running_map.get('dg') or 0.0"/>
                        <t t-set="running_dg_per_cum" t-value="running_dg_monthly / running_divisor if running_dg_monthly else 0.0"/>
                        <t t-set="running_diesel_monthly" t-value="running_map.get('diesel') or 0.0"/>
                        <t t-set="running_diesel_per_cum" t-value="running_diesel_monthly / running_divisor if running_diesel_monthly else 0.0"/>
                        <t t-set="running_admin_monthly" t-value="running_map.get('admin') or 0.0"/>
                        <t t-set="running_admin_per_cum" t-value="running_admin_monthly / running_divisor if running_admin_monthly else 0.0"/>
                        <t t-set="running_interest_monthly" t-value="running_map.get('interest') or 0.0"/>
                        <t t-set="running_interest_per_cum" t-value="running_interest_monthly / running_divisor if running_interest_monthly else 0.0"/>
                        <t t-set="running_land_monthly" t-value="running_map.get('land_investment') or 0.0"/>
                        <t t-set="running_land_per_cum" t-value="running_land_monthly / running_divisor if running_land_monthly else 0.0"/>

                        <section class="mt-4">
                            <h3>Prime Rate</h3>
                            <table class="table table-sm o_main_table">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Monthly</th>
                                        <th>CUM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Running</td>
                                        <td t-esc="formatLang(running_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>Depreciation</td>
                                        <td t-esc="formatLang(depr_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(depr_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr t-if="dead_total or dead_per_cum">
                                        <td><strong>Dead Cost</strong></td>
                                        <td t-esc="formatLang(dead_total, currency_obj=currency)"/>
                                        <td t-esc="formatLang(dead_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>Margin</td>
                                        <td t-esc="formatLang(margin_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(margin_per_cum, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td style="font-weight:600;">Prime Output (Base Rate)</td>
                                        <td style="font-weight:600;" t-esc="formatLang(prime_output_monthly, currency_obj=currency)"/>
                                        <td style="font-weight:600;" t-esc="formatLang(prime_output_per_cum, currency_obj=currency)"/>
                                    </tr>
                                </tfoot>
                            </table>
                        </section>

                        <section class="mt-4">
                            <h3>Optional Services</h3>
                            <t t-set="optional_items" t-value="[opt for opt in (optional_services or []) if (opt.get('per_cum') or opt.get('rate_value') or opt.get('rate') or opt.get('diesel_per_cum') or opt.get('total_amount') or 0.0) != 0]"/>
                            <t t-if="optional_items">
                                <table class="table table-sm o_main_table">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Rate</th>
                                            <th>Qty</th>
                                            <th>Per CUM</th>
                                            <th>Diesel Per CUM</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="optional_items" t-as="opt">
                                        <td t-esc="opt.get('name') or opt.get('label') or opt.get('service') or opt.get('code')"/>
                                        <td t-esc="formatLang(opt.get('rate_value') or opt.get('rate') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(opt.get('quantity') or 0.0, digits=2)"/>
                                        <td t-esc="formatLang(opt.get('per_cum') or opt.get('total') or 0.0, currency_obj=currency)"/>
                                        <t t-set="opt_diesel_pc" t-value="opt.get('diesel_per_cum') if opt.get('code') != 'diesel' else 0.0"/>
                                        <td t-esc="formatLang(opt_diesel_pc or 0.0, currency_obj=currency)"/>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="4" style="text-align:right;font-weight:600;">Optional Cost Total</td>
                                            <td style="font-weight:600;" t-esc="formatLang(final_rate.get('optional_cost') or pdf_data.get('optional_cost') or 0.0, currency_obj=currency)"/>
                                        </tr>
                                    </tfoot>
                                </table>
                            </t>
                            <t t-if="not optional_items">
                                <p>No optional services selected.</p>
                            </t>
                        </section>

                        <section class="mt-3" t-if="optional_items">
                            <t t-set="diesel_breakdown" t-value="[opt for opt in optional_items if opt.get('code') != 'diesel' and (opt.get('diesel_per_cum') or 0.0)]"/>
                            <t t-if="diesel_breakdown">
                                <h4>Diesel Surcharge per CUM</h4>
                                <p class="text-muted small mb-2">Shows which optional rates were used to build the diesel surcharge.</p>
                                <table class="table table-sm o_main_table">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Qty</th>
                                            <th>Diesel per CUM</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr t-foreach="diesel_breakdown" t-as="opt">
                                            <td t-esc="opt.get('name') or opt.get('label') or opt.get('service') or opt.get('code')"/>
                                            <td t-esc="formatLang(opt.get('quantity') or 0.0, digits=2)"/>
                                            <td t-esc="formatLang(opt.get('diesel_per_cum') or 0.0, currency_obj=currency)"/>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="2" style="text-align:right;font-weight:600;">Diesel Surcharge Total</td>
                                            <td style="font-weight:600;" t-esc="formatLang(sum([opt.get('diesel_per_cum') or 0.0 for opt in diesel_breakdown]), currency_obj=currency)"/>
                                        </tr>
                                    </tfoot>
                                </table>
                            </t>
                        </section>

                        <section class="mt-4" t-if="(quotation_context.get('civil_scope') or order.gear_civil_scope) == 'vendor'">
                            <h3>Dead Cost / CAPEX</h3>
                            <t t-set="capex_items" t-value="capex_breakdown.get('items') or []"/>
                            <table class="table table-sm o_main_table" t-if="capex_items">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Status / Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="capex_items" t-as="capex">
                                        <td t-esc="capex.get('label') or capex.get('component')"/>
                                        <td>
                                            <t t-set="capex_amount" t-value="capex.get('amount') or capex.get('total')"/>
                                            <t t-if="capex_amount not in (None, False)">
                                                <t t-esc="formatLang(capex_amount, currency_obj=currency)"/>
                                            </t>
                                            <t t-else="">
                                                Pending finalization
                                            </t>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p>
                                <strong>Dead Cost per CUM:</strong>
                                <t t-set="per_cum" t-value="capex_breakdown.get('dead_cost_per_cum') or dead_cost_context.get('per_cum') or dead_cost_per_cum"/>
                                <t t-if="per_cum">
                                    <t t-esc="formatLang(per_cum, currency_obj=currency)"/>
                                </t>
                                <t t-else="">Pending finalization</t>
                            </p>
                            <p>
                                <strong>CAPEX Total:</strong>
                                <t t-set="capex_total" t-value="capex_breakdown.get('total_amount') or dead_cost_context.get('total') or order.gear_dead_cost_amount"/>
                                <t t-if="capex_total">
                                    <t t-esc="formatLang(capex_total, currency_obj=currency)"/>
                                </t>
                                <t t-else="">Pending finalization</t>
                            </p>
                            <p class="text-muted" t-if="capex_breakdown.get('note')">
                                <em t-esc="capex_breakdown.get('note')"/>
                            </p>
                        </section>

                        <section class="mt-4">
                            <h3>Final Rate per CUM</h3>
                            <t t-set="mgq_value" t-value="plant_slabs.get('mgq') or final_rates.get('mgq') or order.mgq_monthly or order.x_monthly_mgq or 1.0"/>
                            <t t-set="optional_breakdown" t-value="components.get('optional', {}).get('services') or []"/>
                            <t t-set="diesel_optional_per_cum" t-value="sum([(entry.get('per_cum_excluded') or entry.get('per_cum') or 0.0) for entry in optional_breakdown if entry.get('code') == 'diesel'])"/>
                            <t t-set="diesel_running_per_cum" t-value="(running_map.get('diesel') or 0.0) / (mgq_value or 1.0)"/>
                            <t t-set="diesel_per_cum_total" t-value="diesel_optional_per_cum + diesel_running_per_cum"/>
                            <t t-set="margin_per_cum" t-value="components.get('margin', {}).get('per_cum') or 0.0"/>
                            <t t-set="final_prime_rate_value" t-value="final_rates.get('final_prime_rate') or final_rates.get('total_rate_per_cum') or final_rates.get('prime_rate') or slab_rates.get('prime_rate') or 0.0"/>
                            <t t-set="optimize_rate_value" t-value="final_rates.get('final_optimize_rate') or final_rates.get('optimize_rate') or slab_rates.get('optimize_rate') or plant_slabs.get('optimize_rate') or 0.0"/>
                            <t t-set="after_mgq_rate_value" t-value="final_rates.get('final_after_mgq_rate') or final_rates.get('after_mgq_rate') or slab_rates.get('after_mgq_rate') or plant_slabs.get('after_mgq_rate') or 0.0"/>
                            <table class="table table-sm o_main_table w-100">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Per CUM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Prime Output (Base Rate)</td>
                                        <td t-esc="formatLang(prime_output_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>Optional Cost Total</td>
                                        <td t-esc="formatLang(optional_cost_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td style="font-weight:700;">Total Rate</td>
                                        <td style="font-weight:700;" t-esc="formatLang(final_rate.get('total_rate_per_cum') or final_rate.get('final_rate') or slab_rates.get('total_rate_per_cum') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </section>
                        <section class="mt-3">
                            <h3>Optimize Rate</h3>
                            <table class="table table-sm o_main_table w-100">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Per CUM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Diesel (Optional + Running)</td>
                                        <td t-esc="formatLang(diesel_per_cum_total, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>Final Rate</td>
                                        <td t-esc="formatLang(final_prime_rate_value, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td><strong>Optimize Rate</strong></td>
                                        <td t-esc="formatLang(optimize_rate_value, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-muted small mb-0">Optimize Rate = Final Rate - Diesel (per CUM)</p>
                        </section>
                        <section class="mt-3">
                            <h3>After MGQ Rate</h3>
                            <table class="table table-sm o_main_table w-100">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Per CUM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Diesel (Optional + Running)</td>
                                        <td t-esc="formatLang(diesel_per_cum_total, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td>Margin / CUM</td>
                                        <td t-esc="formatLang(margin_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td><strong>Total After MGQ</strong></td>
                                        <td t-esc="formatLang(after_mgq_rate_value, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-muted small mb-0">After MGQ = Diesel + Margin (per CUM)</p>
                        </section>

                        <section class="mt-4" t-if="show_cost_breakdown">
                            <h3>Running Cost Breakdown</h3>
                            <table class="table table-sm o_main_table">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Monthly</th>
                                        <th>Per CUM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-if="running_power_monthly or running_power_per_cum">
                                        <td>Power</td>
                                        <td t-esc="formatLang(running_power_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_power_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr t-if="running_dg_monthly or running_dg_per_cum">
                                        <td>DG</td>
                                        <td t-esc="formatLang(running_dg_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_dg_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr t-if="running_diesel_monthly or running_diesel_per_cum">
                                        <td>Diesel</td>
                                        <td t-esc="formatLang(running_diesel_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_diesel_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr t-if="running_admin_monthly or running_admin_per_cum">
                                        <td>Admin</td>
                                        <td t-esc="formatLang(running_admin_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_admin_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr t-if="running_interest_monthly or running_interest_per_cum">
                                        <td>Interest</td>
                                        <td t-esc="formatLang(running_interest_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_interest_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr t-if="running_land_monthly or running_land_per_cum">
                                        <td>Land / Site Development</td>
                                        <td t-esc="formatLang(running_land_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_land_per_cum, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Running</strong></td>
                                        <td t-esc="formatLang(running_monthly, currency_obj=currency)"/>
                                        <td t-esc="formatLang(running_per_cum, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>
                            <p class="text-muted small mb-0">
                                Source: <t t-esc="running_comp.get('source') or 'N/A'"/>
                            </p>
                        </section>
                    </div>

                    <div class="page">
                        <section class="mt-4" t-if="slab_rates.get('scenarios')">
                            <h3>MGQ Scenario Comparison</h3>
                            <table class="table table-sm o_main_table">
                                <thead>
                                    <tr>
                                        <th>Scenario</th>
                                        <th>Quantity</th>
                                        <th>Prime</th>
                                        <th>Optimize</th>
                                        <th>After MGQ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="slab_rates.get('scenarios')" t-as="scenario">
                                        <td t-esc="scenario.get('label') or scenario.get('code')"/>
                                        <td t-esc="formatLang(scenario.get('qty') or 0.0, digits=2)"/>
                                        <td t-esc="formatLang(scenario.get('prime') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(scenario.get('optimize') or 0.0, currency_obj=currency)"/>
                                        <td t-esc="formatLang(scenario.get('after') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                </tbody>
                            </table>
                        </section>

                        <section class="mt-4" t-if="show_cost_breakdown">
                            <h3>Charts</h3>
                            <t t-set="cost_pie_img" t-value="pdf_data.get('cost_pie_chart') or chart_urls.get('cost_pie')"/>
                            <t t-set="mgq_billing_img" t-value="pdf_data.get('mgq_billing_chart') or chart_urls.get('mgq_bars')"/>
                            <t t-set="diesel_img" t-value="pdf_data.get('diesel_chart') or chart_urls.get('diesel_line')"/>
                            <t t-set="grade_img" t-value="pdf_data.get('grade_chart') or chart_urls.get('grade_comparison')"/>
                            <t t-set="source_map" t-value="pdf_data.get('source_map') or final_rates.get('source_map') or source_map"/>
                            <t t-set="running_map" t-value="source_map.get('running', {}) or running_map"/>
                            <t t-set="capex_map" t-value="source_map.get('capex', {})"/>
                            <t t-set="dead_map" t-value="source_map.get('dead_cost', {})"/>
                            <t t-set="intermediate_map" t-value="source_map.get('intermediate_values', {})"/>
                            <div class="mb-3" t-if="cost_pie_img">
                                <p class="fw-bold mb-1">Cost Breakdown</p>
                                <img t-att-src="cost_pie_img" alt="Cost breakdown chart"/>
                            </div>
                            <t t-set="running_total_display" t-value="(running_map.get('land_investment') or 0.0)
                                + (running_map.get('power') or 0.0)
                                + (running_map.get('dg') or 0.0)
                                + (running_map.get('diesel') or 0.0)
                                + (running_map.get('admin') or 0.0)
                                + (running_map.get('interest') or 0.0)"/>
                            <table class="table table-sm o_main_table" t-if="source_map">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="2"><strong>Running Cost (Monthly)</strong></td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" class="text-muted">Fixed Components</td>
                                    </tr>
                                    <tr t-if="running_map.get('land_investment')">
                                        <td>Land / Site Development</td>
                                        <td t-esc="formatLang(running_map.get('land_investment') or 0.0, currency_obj=currency)"/>
                                    </tr>
                                    <tr>
                                        <td colspan="2" class="text-muted">Variable Components</td>
                                    </tr>
                                    <tr><td>Power</td><td t-esc="formatLang(running_map.get('power') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>DG</td><td t-esc="formatLang(running_map.get('dg') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Diesel</td><td t-esc="formatLang(running_map.get('diesel') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Admin</td><td t-esc="formatLang(running_map.get('admin') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Interest</td><td t-esc="formatLang(running_map.get('interest') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td><strong>Running Total</strong></td><td t-esc="formatLang(running_total_display or 0.0, currency_obj=currency)"/></tr>
                                    <tr>
                                        <td colspan="2"><strong>CAPEX</strong></td>
                                    </tr>
                                    <tr><td>Plant &amp; Machinery</td><td t-esc="formatLang(capex_map.get('plant_machinery') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Furniture</td><td t-esc="formatLang(capex_map.get('furniture') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Equipment &amp; Fittings</td><td t-esc="formatLang(capex_map.get('equipment_fittings') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Computers &amp; Peripherals</td><td t-esc="formatLang(capex_map.get('computers_peripherals') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td><strong>Total CAPEX</strong></td><td t-esc="formatLang(capex_map.get('total_capex') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Monthly Depreciation</td><td t-esc="formatLang(capex_map.get('monthly_depr') or 0.0, currency_obj=currency)"/></tr>
                                    <tr>
                                        <td colspan="2"><strong>Dead Cost</strong></td>
                                    </tr>
                                    <tr><td>Factory Building</td><td t-esc="formatLang(dead_map.get('civil_factory_building') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Non-Factory Building</td><td t-esc="formatLang(dead_map.get('civil_non_factory_building') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td><strong>Dead Cost Total</strong></td><td t-esc="formatLang(dead_map.get('dead_total') or 0.0, currency_obj=currency)"/></tr>
                                    <tr>
                                        <td colspan="2"><strong>Margin &amp; Prime</strong></td>
                                    </tr>
                                    <tr><td>Margin / CUM</td><td t-esc="formatLang(final_rates.get('margin_per_cum') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Prime Rate (before margin)</td><td t-esc="formatLang(final_rates.get('prime_rate') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td>Final Prime Rate</td><td t-esc="formatLang(final_rates.get('final_prime_rate') or final_rates.get('total_per_cum') or 0.0, currency_obj=currency)"/></tr>
                                    <tr><td colspan="2" class="text-muted">Final Prime Rate = Prime Rate + Margin / CUM</td></tr>
                                    <tr>
                                        <td colspan="2"><strong>Calculation Inputs</strong></td>
                                    </tr>
                                    <tr><td>Duration (months)</td><td t-esc="formatLang(intermediate_map.get('duration_months') or 0.0, digits=2)"/></tr>
                                    <tr><td>MGQ Used</td><td t-esc="formatLang(intermediate_map.get('MGQ') or 0.0, digits=2)"/></tr>
                                </tbody>
                            </table>
                            <div class="mb-3" t-if="mgq_billing_img">
                                <p class="fw-bold mb-1">MGQ Billing</p>
                                <img t-att-src="mgq_billing_img" alt="MGQ billing chart"/>
                            </div>
                            <div class="mb-3" t-if="diesel_img">
                                <p class="fw-bold mb-1">Diesel Escalation</p>
                                <img t-att-src="diesel_img" alt="Diesel escalation chart"/>
                            </div>
                            <div class="mb-3" t-if="grade_img">
                                <p class="fw-bold mb-1">Grade Comparison</p>
                                <img t-att-src="grade_img" alt="Grade comparison chart"/>
                            </div>
                        </section>

                        <div class="text-muted text-center small mt-4">
                            Generated by Tech Paras - Automate Excellence - https://www.smarterpeak.com
                        </div>
                        </div>
                    </t>
                </t>

                <t t-if="not order">
                    <div class="page">
                        <h3>Batching Plant Quotation</h3>
                        <p>No data available for this report.</p>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
